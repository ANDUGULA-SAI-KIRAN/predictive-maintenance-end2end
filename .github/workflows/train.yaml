name: Continuous Training
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  train:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.7'

      - name: Install dependencies
        run: |
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          echo "âœ… Dependencies installed successfully"

      - name: Pull data from DagsHub (DVC)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.DAGSHUB_USER_TOKEN }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DAGSHUB_USER_TOKEN }}
        run: |
          dvc pull

      - name: Reproduce Pipeline
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_USER_TOKEN }}
        run: dvc repro  # This runs ingest -> preprocess -> train -> evaluate

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Verify Training Output
        run: |
          if [ ! -f "reports/metrics.json" ]; then
            echo "âŒ ERROR: reports/metrics.json not found!"
            exit 1
          fi
          echo "âœ… Metrics file found"
          echo "ðŸ“Š Metrics content:"
          cat reports/metrics.json

      - name: Create and Post Report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create markdown report
          echo "## ðŸš€ Model Training Report" > report.md
          echo "### Performance Metrics" >> report.md
          echo "" >> report.md
          
          # Format metrics.json into a readable markdown table
          python3 << 'EOF'
          import json
          import os
          
          # Verify file exists
          if not os.path.exists('reports/metrics.json'):
              print("âŒ ERROR: reports/metrics.json not found!")
              exit(1)
          
          with open('reports/metrics.json', 'r') as f:
              metrics = json.load(f)
          
          if not metrics:
              print("âš ï¸ WARNING: metrics.json is empty!")
              exit(1)
          
          # Create markdown table
          with open('report.md', 'a') as f:
              f.write("| Metric | Value |\n")
              f.write("|--------|-------|\n")
              for key, value in metrics.items():
                  if isinstance(value, (int, float)):
                      f.write(f"| {key} | {value:.4f} |\n")
                  else:
                      f.write(f"| {key} | {value} |\n")
          
          print("âœ… Report generated successfully")
          EOF
          
          echo ""
          echo "ðŸ“Š Generated Report:"
          cat report.md
          
          # Post the report as a comment (optional - may fail on forks)
          cml comment create report.md || echo "âš ï¸ Could not post comment (token permissions issue on fork/PR)"